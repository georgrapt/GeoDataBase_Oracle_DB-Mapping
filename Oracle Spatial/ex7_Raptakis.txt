--Raptakis Giorgos
--Exercise 7

--Oracle SDO_GEOMETRY- Test area

DROP TABLE person CASCADE CONSTRAINT PURGE;
DROP TABLE propertyperson CASCADE CONSTRAINT PURGE;
DROP TABLE street CASCADE CONSTRAINT PURGE;
DROP TABLE municipality CASCADE CONSTRAINT PURGE;
DROP TABLE property CASCADE CONSTRAINT PURGE;
DROP TABLE polygon CASCADE CONSTRAINT PURGE;
DROP TABLE building CASCADE CONSTRAINT PURGE;
DROP TABLE point CASCADE CONSTRAINT PURGE;
DROP TABLE edge CASCADE CONSTRAINT PURGE;
DROP TABLE polygonedge CASCADE CONSTRAINT PURGE;

CREATE TABLE polygon (
	IDpolygon INTEGER CONSTRAINT PK_polygon PRIMARY KEY
 	propertyID INTEGER, 
	buildingID INTEGER
  geom SDO_GEOMETRY
);

INSERT INTO polygon VALUES (1001);
INSERT INTO polygon VALUES (1002);
INSERT INTO polygon VALUES (1);
INSERT INTO polygon VALUES (2);
INSERT INTO polygon VALUES (3);
INSERT INTO polygon VALUES (4);
INSERT INTO polygon VALUES (5);
INSERT INTO polygon VALUES (6);
INSERT INTO polygon VALUES (7);
INSERT INTO polygon VALUES (8);
INSERT INTO polygon VALUES (9);
INSERT INTO polygon VALUES (10);
INSERT INTO polygon VALUES (11);
INSERT INTO polygon VALUES (12);

CREATE TABLE municipality (
	IDmunicipality INTEGER CONSTRAINT PK_municipality PRIMARY KEY, 
	polygonID INTEGER
);

CREATE TABLE property (
	IDproperty INTEGER CONSTRAINT PK_property PRIMARY KEY,
	propertynumber INTEGER, 
  fburden NUMBER(8,2),  
	municipalityID INTEGER,
  polygonID INTEGER
);

ALTER TABLE property
	ADD CONSTRAINT FK_property_municipality FOREIGN KEY (municipalityID) 
  REFERENCES municipality (IDmunicipality);
ALTER TABLE property
	ADD CONSTRAINT FK_polygon_property FOREIGN KEY (polygonID) 
  REFERENCES polygon (IDpolygon); 

CREATE TABLE building (
	IDbuilding INTEGER CONSTRAINT PK_building PRIMARY KEY, 
	propertyID INTEGER,
  polygonID INTEGER,
	floors INTEGER, 
	streetname VARCHAR2(250), 
	no VARCHAR2(20)
);
ALTER TABLE building
	ADD CONSTRAINT FK_building_property FOREIGN KEY (propertyID) 
  REFERENCES property (IDproperty);
ALTER TABLE building
	ADD CONSTRAINT FK_polygon_build FOREIGN KEY (polygonID) 
  REFERENCES polygon (IDpolygon);
  
CREATE TABLE point (
	IDpoint INTEGER CONSTRAINT PK_point PRIMARY KEY, 
	x NUMERIC(10,3), 
	y NUMERIC(10,3)
  geom SDO_GEOMETRY
);

CREATE TABLE person (
  IDperson number(10) CONSTRAINT PK_person PRIMARY KEY,
  name varchar(50) default NULL,
  givenname varchar(50) default NULL
);

INSERT INTO person (SELECT nr AS IDperson, name, given_name 
  FROM students_15) ORDER BY name;

CREATE TABLE propertyperson (
	personID INTEGER, 
	propertyID INTEGER	
);
ALTER TABLE propertyperson
	ADD CONSTRAINT PK_propertyperson PRIMARY KEY  (personID, propertyID);
ALTER TABLE propertyperson
	ADD CONSTRAINT FK_propertyperson_person FOREIGN KEY (personID) 
  REFERENCES person (IDperson);
ALTER TABLE propertyperson
	ADD CONSTRAINT FK_propertyperson_property FOREIGN KEY (propertyID) 
  REFERENCES property (IDproperty);

CREATE TABLE street (
	IDstreet INTEGER CONSTRAINT PK_street PRIMARY KEY, 
	streetname VARCHAR2(250), 
	usage VARCHAR2(50)
);
ALTER TABLE street ADD CONSTRAINT FK_street_parcel FOREIGN KEY (IDstreet) 
REFERENCES property (IDproperty);


INSERT INTO municipality  VALUES (1, 1001);
INSERT INTO municipality VALUES (2, 1002);

INSERT INTO property VALUES (1, 11, 15000.0, 1, 1);
INSERT INTO property VALUES (2, 12, 1000.0, 1, 2);
INSERT INTO property VALUES (3, 13, 2500.0, 1, 3);
INSERT INTO property VALUES (4, 14, 100.0, 2, 4);
INSERT INTO property VALUES (6, 16, 0.0, 1, 6);
INSERT INTO property VALUES (7, 17, 0.0, 2, 7);
INSERT INTO property VALUES (8, 18, 10000.0, 1, 8);
INSERT INTO property VALUES (9, 19, 0.0, 1, 9);
INSERT INTO property VALUES (10, 20, 0.0, 1, 10);
INSERT INTO property VALUES (11, 21, 30000.0, 2, 11);

INSERT INTO street VALUES (6, 'Main Road','high speed');
INSERT INTO street VALUES (7, 'Field Road','low speed');

INSERT INTO propertyperson VALUES (22, 1);
INSERT INTO propertyperson VALUES (32, 2);
INSERT INTO propertyperson VALUES (18, 3);
INSERT INTO propertyperson VALUES (12, 4);
INSERT INTO propertyperson VALUES (28, 6);
INSERT INTO propertyperson VALUES (35, 7);
INSERT INTO propertyperson VALUES (10, 8);
INSERT INTO propertyperson VALUES (23, 9);
INSERT INTO propertyperson VALUES (33, 10);

INSERT INTO building VALUES (1, 4, 5, 2, 'Field Road', '767');

--put the SDO_GEOMETRY polygon 
--municipality
INSERT INTO polygon VALUES (1001, NULL, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(0,0, 40,60))); 
INSERT INTO polygon VALUES (1002, NULL, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(40,0, 80,60)));
--polygon
INSERT INTO polygon VALUES (1, 1, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(0,0, 20,20)));
INSERT INTO polygon VALUES (2, 2, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(20,0, 40,30)));
INSERT INTO polygon VALUES (3, 3, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(0,20, 20,30)));
INSERT INTO polygon VALUES (4, 4, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(40,0, 80,30)));
INSERT INTO polygon VALUES (5, 4,1, SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(50,10, 70,20)));
INSERT INTO polygon VALUES (6, 6, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(0,30, 40,40)));
INSERT INTO polygon VALUES (7, 7, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(40,30, 80,40)));
INSERT INTO polygon VALUES (8, 8, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(0,40, 10,60)));
INSERT INTO polygon VALUES (9, 9, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(10,40, 30,60)));
INSERT INTO polygon VALUES (10, 10, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(30,40, 40,60)));
INSERT INTO polygon VALUES (11, 11, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,3), SDO_ORDINATE_ARRAY(40,40, 80,60)));
INSERT INTO polygon VALUES (12, 11, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1005,4, 1,2,1, 3,2,2, 7,2,1, 9,2,2), SDO_ORDINATE_ARRAY(64,60, 70,60, 72.929,52.929, 80,50, 80,44, 68.686,48.686, 64,60)));
INSERT INTO polygon VALUES (13, 11, NULL,SDO_GEOMETRY(2003, NULL, NULL, SDO_ELEM_INFO_ARRAY(1,1003,4), SDO_ORDINATE_ARRAY(69,53, 71,53, 70,51)));

--Put the SDO_GEOMETRY point
--The tree in Sophie's property
INSERT INTO point VALUES (200,75,20,SDO_GEOMETRY(200 NULL, SDO_POINT_TYPE(75,20, NULL), null, null));
--Insert Point 
INSERT INTO point VALUES (1, 0, 0,SDO_GEOMETRY(1 NULL, SDO_POINT_TYPE(0,0, NULL), null, null));
INSERT INTO point VALUES (2, 20, 0,SDO_GEOMETRY(2 NULL, SDO_POINT_TYPE(20,0, NULL), null, null));
INSERT INTO point VALUES (3, 40, 0,SDO_GEOMETRY(3 NULL, SDO_POINT_TYPE(40,0, NULL), null, null));
INSERT INTO point VALUES (4, 80, 0,SDO_GEOMETRY(4 NULL, SDO_POINT_TYPE(80,0, NULL), null, null));
INSERT INTO point VALUES (5, 0, 20,SDO_GEOMETRY(5 NULL, SDO_POINT_TYPE(0,20, NULL), null, null));
INSERT INTO point VALUES (6, 20, 20,SDO_GEOMETRY(6 NULL, SDO_POINT_TYPE(20,20, NULL), null, null));
INSERT INTO point VALUES (7, 0, 30,SDO_GEOMETRY(7 NULL, SDO_POINT_TYPE(0,30, NULL), null, null));
INSERT INTO point VALUES (8, 40, 30,SDO_GEOMETRY(8 NULL, SDO_POINT_TYPE(40,30, NULL), null, null));
INSERT INTO point VALUES (9, 40, 30,SDO_GEOMETRY(9 NULL, SDO_POINT_TYPE(40,30, NULL), null, null));
INSERT INTO point VALUES (10, 80, 30,SDO_GEOMETRY(10 NULL, SDO_POINT_TYPE(80,30, NULL), null, null));
INSERT INTO point VALUES (11, 0, 40,SDO_GEOMETRY(11 NULL, SDO_POINT_TYPE(0,40, NULL), null, null));
INSERT INTO point VALUES (12, 10, 40,SDO_GEOMETRY(12 NULL, SDO_POINT_TYPE(10,40, NULL), null, null));
INSERT INTO point VALUES (13, 30, 40,SDO_GEOMETRY(13 NULL, SDO_POINT_TYPE(30,40, NULL), null, null));
INSERT INTO point VALUES (14, 40, 40,SDO_GEOMETRY(14 NULL, SDO_POINT_TYPE(40,40, NULL), null, null));
INSERT INTO point VALUES (15, 80, 40,SDO_GEOMETRY(15 NULL, SDO_POINT_TYPE(80,40, NULL), null, null));
INSERT INTO point VALUES (16, 0, 60,SDO_GEOMETRY(16 NULL, SDO_POINT_TYPE(0,60, NULL), null, null));
INSERT INTO point VALUES (17, 10, 60,SDO_GEOMETRY(17 NULL, SDO_POINT_TYPE(10,60, NULL), null, null));
INSERT INTO point VALUES (18, 30, 60,SDO_GEOMETRY(18 NULL, SDO_POINT_TYPE(30,60, NULL), null, null));
INSERT INTO point VALUES (19, 40, 60,SDO_GEOMETRY(19 NULL, SDO_POINT_TYPE(40,60, NULL), null, null));
INSERT INTO point VALUES (20, 80, 60,SDO_GEOMETRY(20 NULL, SDO_POINT_TYPE(80,60, NULL), null, null));
INSERT INTO point VALUES (101,50,10,SDO_GEOMETRY(101 NULL, SDO_POINT_TYPE(50,10, NULL), null, null));
INSERT INTO point VALUES (102, 70,10,SDO_GEOMETRY(102 NULL, SDO_POINT_TYPE(70,10, NULL), null, null));
INSERT INTO point VALUES (103,70,20,SDO_GEOMETRY(103 NULL, SDO_POINT_TYPE(70,20, NULL), null, null));
INSERT INTO point VALUES (104,50,20,SDO_GEOMETRY(104 NULL, SDO_POINT_TYPE(50,20, NULL), null, null));

COMMIT;


--SQL-Queries

--a. Calculate the circumference of each property:
SELECT IDproperty, SDO_GEOM.SDO_LENGTH(geom, 0.01),NAME,GIVENNAME
FROM polygon, person 
JOIN PROPERTYPESON ON PERSON.IDPERSON=PROPERTYPERSON.PERSONID
JOIN property ON PROPERTYPESON.PROPERTYID=PROPERTY.IDPROPERTY 
WHERE IDproperty IS NOT NULL 
ORDER BY IDproperty;

-- b. Calculate the are for each property:
SELECT IDproperty AS property, SDO_GEOM.SDO_AREA(geom, 0.001) AS area
FROM polygon WHERE IDproperty IS NOT NULL 
ORDER BY area DESC,  property;

-- c. calculate the distance from property 3 to all other properties:
SELECT pol1.IDproperty as property, SDO_GEOM_SDO_DISTANCE(pol1.geom, pol2.geom, 0.01) as distance_3
FROM polygon pol1, polygon pol2
WHERE pol1.IDproperty = 3 AND pol2.IDproperty IS NOT NULL AND pol2.IDproperty != 3
ORDER BY distance_3, pol2.propertyid;   

